{% extends 'base.html' %}
{% block content %}
<section class="auth-section" data-aos="fade-up">
  <h2>Register</h2>
  <form id="registerForm">
    <label>Username</label>
    <div class="input-group"><i class='bx bx-user'></i><input type="text" id="username" name="username" required></div>

    <label>Email</label>
    <div class="input-group"><i class='bx bx-envelope'></i><input type="email" id="email" name="email" required></div>

    <label>Phone</label>
    <div class="input-group"><i class='bx bx-phone'></i><input type="text" id="phone" name="phone"></div>

    <label>Password</label>
    <div class="input-group pw-group"><i class='bx bx-lock'></i><input class="pw-input" type="password" id="password" name="password" required minlength="6"><i class='bx bx-hide pw-toggle' title="Show/Hide password" style="cursor:pointer"></i></div>

    <label>Confirm Password</label>
    <div class="input-group pw-group"><i class='bx bx-lock'></i><input class="pw-input" type="password" id="confirm_password" name="confirm_password" required><i class='bx bx-hide pw-toggle' title="Show/Hide password" style="cursor:pointer"></i></div>

    <button class="btn primary" type="submit" id="registerBtn">Register</button>
  </form>

  <div id="authMessage" style="margin-top: 15px; padding: 10px; border-radius: 6px; display: none;"></div>
</section>

<script type="module">
  import { registerWithEmail } from '/static/js/auth.js';

  const registerForm = document.getElementById('registerForm');
  const authMessage = document.getElementById('authMessage');
  const registerBtn = document.getElementById('registerBtn');

  function showMessage(message, type) {
    authMessage.textContent = message;
    authMessage.style.display = 'block';
    authMessage.className = '';
    
    if (type === 'success') {
      authMessage.style.background = '#d4edda';
      authMessage.style.color = '#155724';
    } else if (type === 'error') {
      authMessage.style.background = '#f8d7da';
      authMessage.style.color = '#721c24';
    } else {
      authMessage.style.background = '#fff3cd';
      authMessage.style.color = '#856404';
    }
  }

  registerForm.addEventListener('submit', async (e) => {
    e.preventDefault();
    
    const username = document.getElementById('username').value;
    const email = document.getElementById('email').value;
    const phone = document.getElementById('phone').value;
    const password = document.getElementById('password').value;
    const confirmPassword = document.getElementById('confirm_password').value;
    
    // Validate passwords match
    if (password !== confirmPassword) {
      showMessage('Passwords do not match', 'error');
      return;
    }

    // Validate password length
    if (password.length < 6) {
      showMessage('Password must be at least 6 characters', 'error');
      return;
    }
    
    registerBtn.disabled = true;
    registerBtn.textContent = 'Registering...';
    
    const result = await registerWithEmail(email, password, username, phone);
    
    if (result.success) {
      // Check if admin account was created
      let message = 'Registration successful! Redirecting to login...';
      if (result.data && result.data.role === 'admin') {
        message = 'ðŸ‘‘ Admin account created successfully! Redirecting to login...';
      }
      showMessage(message, 'success');
      setTimeout(() => {
        window.location.href = '/login';
      }, 2000);
    } else {
      showMessage(result.error, 'error');
      registerBtn.disabled = false;
      registerBtn.textContent = 'Register';
    }
  });
</script>
{% endblock %}
